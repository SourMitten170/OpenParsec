name: Build OpenParsec IPA

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1

    - name: Install Fastlane
      run: gem install fastlane

    - name: Set up Fastlane Fastfile
      run: |
        mkdir -p fastlane
        echo "default_platform(:ios)

        platform :ios do
          lane :build do
            build_app(
              scheme: 'OpenParsec',
              output_directory: './output',
              output_name: 'OpenParsec.ipa'
            )
          end
        end" > fastlane/Fastfile

    - name: Build IPA
      run: fastlane build

    - name: Upload IPA to Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "output/OpenParsec.ipa"
        tag: "latest"
        allowUpdates: true
        name: "OpenParsec Build"
